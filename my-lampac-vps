(function() {
    'use strict';

    Lampa.Platform.tv();

    var server_protocol = location.protocol === "https:" ? 'https://' : 'http://';
    var icon_server_redirect = '<svg width="256px" height="256px" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="..."/></g></svg>'; // svg сокращен для наглядности

    function createRedirectButton() {
        $('#REDIRECT').remove();

        if (!Lampa.Storage.get('location_server')) return;

        var domainBUTT = '<div id="REDIRECT" class="head__action selector redirect-screen">' + icon_server_redirect + '</div>';

        $('#app > div.head > div > div.head__actions').append(domainBUTT);
        $('#REDIRECT').insertAfter('div.head__action.selector.open--settings');

        $('#REDIRECT').off('hover:enter hover:click hover:touch').on('hover:enter hover:click hover:touch', function() {
            window.location.href = server_protocol + Lampa.Storage.get('location_server');
        });
    }

    function startMe() {
        // Устанавливаем постоянный адрес по умолчанию, если не установлен
        if (!Lampa.Storage.get('location_server')) {
            Lampa.Storage.set('location_server', '193.169.241.242:12123');
        }

        createRedirectButton();

        Lampa.SettingsApi.addComponent({
            component: 'location_redirect',
            name: 'Смена сервера',
            icon: icon_server_redirect
        });

        Lampa.SettingsApi.addParam({
            component: 'location_redirect',
            param: {
                name: 'location_server',
                type: 'input',
                placeholder: 'Пример: reyohoho.space:9912',
                default: ''
            },
            field: {
                name: 'Адрес сервера',
                description: 'Нажмите для ввода, смену сервера можно будет сделать кнопкой в верхнем баре'
            },
            onChange: function(value) {
                if (!value) {
                    $('#REDIRECT').remove();
                } else {
                    Lampa.Storage.set('location_server', value);
                    createRedirectButton();
                }
            }
        });

        Lampa.SettingsApi.addParam({
            component: 'location_redirect',
            param: {
                name: 'const_redirect',
                type: 'trigger',
                default: false
            },
            field: {
                name: 'Постоянный редирект',
                description: 'Чтобы отключить постоянный редирект, нажмите клавишу ВНИЗ при загрузке приложения'
            }
        });

        Lampa.Keypad.listener.follow("keydown", function(e) {
            if (e.code === "ArrowDown" || e.code === "Numpad2") {
                Lampa.Storage.set('const_redirect', false);
            }
        });

        setTimeout(function() {
            if (Lampa.Storage.get('const_redirect') === true || Lampa.Storage.get('const_redirect') === 'true') {
                if (Lampa.Storage.get('location_server')) {
                    window.location.href = server_protocol + Lampa.Storage.get('location_server');
                }
            }
        }, 300);
    }

    if (window.appready) {
        startMe();
    } else {
        Lampa.Listener.follow('app', function(e) {
            if (e.type === 'ready') {
                startMe();
            }
        });
    }
})();
